(function(t,e,i,s){"use strict";function a(i,s){this.element=i,this.settings=t.extend({},o,s),this._defaults=o,this._name=n,this.key=this.settings.pageVarKey,this.wrapper=t(this.settings.wrapper),this.mode=this.settings.mode,this.reached=!1,this.history=this.settings.history,this.oldBrowser=!(e.history&&history.pushState),this.init()}var n="pdoPage",o={wrapper:"#pdopage",rows:"#pdopage .row",pagination:"#pdopage .pagination",link:"#pdopage .pagination a",more:"#pdopage .btn-more",pdoTitle:"#pdopage .title",moreTpl:'<button class="btn btn-default btn-more">Load more</button>',waitAnimation:'<div class="wait-wrapper"><div class="wait"></div></div>',mode:"scroll",pageVarKey:"page",pageLimit:12,assetsUrl:"/assets/components/pdotools/",scrollTop:!0};t.extend(a.prototype,{init:function(){var e=this;if(this.page==s){var i=this.hashGet(),a=i[this.key]==s?1:i[this.key];this.page=Number(a)}switch(this.mode){case"default":this.initDefault();break;case"scroll":case"button":if(this.history){if("undefined"==typeof jQuery().sticky)return void t.getScript(this.settings.assetsUrl+"js/lib/jquery.sticky.js",function(){e.init(e.settings)});this.stickyPagination()}else t(this.settings.pagination).hide();"button"==this.mode?this.initButton():this.initScroll()}},initDefault:function(){var s=this;t(i).on("click",this.settings.link,function(e){e.preventDefault();var i=t(this).prop("href"),a=i.match(new RegExp(s.key+"[=|/](\\d+)")),n=a?a[1]:1;s.page!=n&&(s.history&&s.hashAdd(s.key,n),s.loadPage(i))}),this.history&&(t(e).on("popstate",function(t){t.originalEvent.state&&t.originalEvent.state.pdoPage&&s.loadPage(t.originalEvent.state.pdoPage)}),history.replaceState({pdoPage:e.location.href},""))},initButton:function(){var e=this;t(this.settings.rows).after(this.settings.moreTpl);var s=!1;t(this.settings.link).each(function(){var i=t(this).prop("href"),a=i.match(new RegExp(e.key+"[=|/](\\d+)")),n=a?a[1]:1;if(n>e.page)return s=!0,!1}),s||t(this.settings.more).hide(),t(i).on("click",this.settings.more,function(t){t.preventDefault(),e.addPage()})},initScroll:function(){var i=this,s=t(e);s.on("scroll",function(){!i.reached&&s.scrollTop()>i.wrapper.height()-s.height()&&(i.reached=!0,i.addPage())})},addPage:function(){var e=this,i=this.hashGet(),s=i[this.key]||1;t(this.settings.link).each(function(){var i=t(this).prop("href"),a=i.match(new RegExp(e.key+"[=|/](\\d+)")),n=a?Number(a[1]):1;if(n>s)return e.history&&e.hashAdd(e.key,n),e.page=s,e.loadPage(i,"append"),!1})},loadPage:function(i,s){var a=this,n=t(this.settings.rows),o=t(this.settings.pagination),r=i.match(new RegExp(this.key+"=(\\d+)")),p=r?Number(r[1]):1;if(s||(s="replace"),this.page!=p||"force"==s){this.wrapper.trigger("beforeLoad",[this,this.settings]),"scroll"!=this.mode&&this.wrapper.css({opacity:.3}),this.page=p;var h=t(this.settings.waitAnimation);"append"==s?this.wrapper.find(n).append(h):this.wrapper.find(n).empty().append(h);var l=this.getUrlParameters(i);l[this.key]=this.page,t.get(e.location.pathname,l,function(e){e&&(a.wrapper.find(o).replaceWith(e.pagination),"append"==s?(a.wrapper.find(n).append(e.output),"button"==a.mode?e.pages==e.page?t(a.settings.more).hide():t(a.settings.more).show():"scroll"==a.mode&&(a.reached=!1),h.remove()):(a.wrapper.find(n).html(e.output),"force"==s&&a.history&&a.hashSet(l)),a.wrapper.trigger("afterLoad",[a,a.settings,e]),"scroll"!=a.mode&&(a.wrapper.css({opacity:1}),"default"==a.mode&&a.settings.scrollTop&&t("html, body").animate({scrollTop:a.wrapper.position().top-50||0},0)),a.updateTitle(e))},"json")}},stickyPagination:function(){var e=t(this.settings.pagination);e.is(":visible")&&(e.sticky({wrapperClassName:"sticky-pagination",getWidthFrom:this.settings.pagination,responsiveWidth:!0}),this.wrapper.trigger("scroll"))},updateTitle:function(e){if("undefined"!=typeof pdoTitle){for(var i=t("title"),s=pdoTitle.separator||" / ",a=pdoTitle.tpl,n=[],o=i.text().split(s),r=new RegExp("^"+a.split(" ")[0]+" "),p=0;p<o.length;p++)1===p&&e.page&&e.page>1&&n.push(a.replace("{page}",e.page).replace("{pageCount}",e.pages)),o[p].match(r)||n.push(o[p]);i.text(n.join(s))}},getUrlParameters:function(t){var e={},i=t.indexOf("?");return i!==-1&&(e=this.deparam(t.substring(i+1))),e},deparam:function(e){var i,s,a=/^\d+$/,n=/([^\[\]]+)|(\[\])/g,o=/([^?#]*)(#.*)?$/,r=function(t){return decodeURIComponent(t.replace(/\+/g," "))},p={};return e&&o.test(e)&&(i=e.split("&"),t.each(i,function(t,e){var i=e.split("="),o=r(i.shift()),h=r(i.join("=")),l=p;if(o){i=o.match(n);for(var d=0,c=i.length-1;d<c;d++)l[i[d]]||(l[i[d]]=a.test(i[d+1])||"[]"===i[d+1]?[]:{}),l=l[i[d]];s=i.pop(),"[]"===s?l.push(h):l[s]=h}})),p},hashGet:function(){var t,i,s={};if(this.oldBrowser){if(i=decodeURIComponent(e.location.hash.substr(1)),i.length){i=i.split("/");for(var a in i)i.hasOwnProperty(a)&&(t=i[a].split("="),"undefined"==typeof t[1]?s.anchor=t[0]:s[t[0]]=t[1])}}else{var n=e.location.href.indexOf("?");i=n!=-1?decodeURIComponent(e.location.href.substr(n+1)):"",s=this.deparam(i)}return s},hashSet:function(t){var i="";for(var s in t)if(t.hasOwnProperty(s))if("object"!=typeof t[s])i+="&"+s+"="+t[s];else for(var a in t[s])t[s].hasOwnProperty(a)&&(i+=!isNaN(parseFloat(a))&&isFinite(parseFloat(a))?"&"+s+"[]="+t[s][a]:"&"+s+"["+a+"]="+t[s][a]);this.oldBrowser?e.location.hash=i.substr(1):(0!=i.length&&(i="?"+i.substr(1)),e.history.pushState({pdoPage:e.location.pathname+i},"",e.location.pathname+i))},hashAdd:function(t,e){var i=this.hashGet();i[t]=e,this.hashSet(i)},hashRemove:function(t){var e=this.hashGet();delete e[t],this.hashSet(e)},hashClear:function(){this.hashSet({})}}),t.fn[n]=function(e){var i=arguments;if(e===s||"object"==typeof e)return this.each(function(){t.data(this,"plugin_"+n)||t.data(this,"plugin_"+n,new a(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){var o;return this.each(function(){var s=t.data(this,"plugin_"+n);s instanceof a&&"function"==typeof s[e]&&(o=s[e].apply(s,Array.prototype.slice.call(i,1))),"destroy"===e&&t.data(this,"plugin_"+n,null)}),o!==s?o:this}}})(jQuery,window,document);